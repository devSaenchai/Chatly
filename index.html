<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chatly Ultra v4</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0b141a}
.msg{max-width:78%}
.fade{transition:.25s}
.typing-dot{display:inline-block;width:4px;height:4px;border-radius:50%;background:#cbd5e1;margin-right:2px;animation:b 1s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes b{0%,80%,100%{opacity:.2}40%{opacity:1}}
</style>
</head>

<body class="h-screen flex flex-col text-white">

<!-- HEADER -->
<div id="header" class="bg-[#202c33] p-3 font-semibold flex items-center gap-2">
<button id="backBtn" class="hidden">‚Üê</button>
<div id="headerTitle">Chatly</div>
</div>

<!-- HOME / USERS -->
<div id="home" class="flex-1 overflow-y-auto"></div>

<!-- CHAT -->
<div id="chatScreen" class="hidden flex flex-col flex-1">
<div id="chat" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
<div id="typing" class="text-xs px-3 opacity-70 h-5"></div>
<div class="bg-[#202c33] p-2 flex gap-2">
<input id="msg" class="flex-1 p-2 rounded-full text-black" placeholder="Message">
<button onclick="send()" class="bg-[#005c4b] px-4 rounded-full">Send</button>
</div>
</div>

<!-- SETUP -->
<div id="setup" class="fixed inset-0 bg-black/70 flex items-center justify-center">
<div class="bg-[#202c33] p-6 rounded-xl w-80 space-y-3">
<input id="nameInput" placeholder="Username" class="w-full p-2 rounded text-black">
<button onclick="saveProfile()" class="bg-[#005c4b] w-full p-2 rounded">Start</button>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getDatabase,ref,set,push,onValue,onChildAdded,update,onDisconnect,remove
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyDaoRzu6_cpPxeAjoX6kbsTCUlf5Vpn4Kg",
authDomain:"chatly-2f097.firebaseapp.com",
databaseURL:"https://chatly-2f097-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chatly-2f097",
storageBucket:"chatly-2f097.firebasestorage.app",
messagingSenderId:"632092552334",
appId:"1:632092552334:web:b1390de09936da2516eddf"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ELEMENTS */
const setup=document.getElementById("setup");
const nameInput=document.getElementById("nameInput");
const home=document.getElementById("home");
const chatScreen=document.getElementById("chatScreen");
const headerTitle=document.getElementById("headerTitle");
const backBtn=document.getElementById("backBtn");
const chat=document.getElementById("chat");
const typing=document.getElementById("typing");
const msg=document.getElementById("msg");

let profile=JSON.parse(localStorage.getItem("chatlyUser"));
let currentUser=null;
let currentChatId=null;
let lastDay=null;

if(profile){
setup.style.display="none";
setPresence();
loadUsers();
}

/* PROFILE */
window.saveProfile=()=>{
const name=nameInput.value.trim();
if(!name)return alert("Enter username");
profile={name};
localStorage.setItem("chatlyUser",JSON.stringify(profile));
set(ref(db,"users/"+name),profile).then(()=>{
setup.style.display="none";
setPresence();
loadUsers();
});
};

/* PRESENCE */
function setPresence(){
const statusRef=ref(db,"status/"+profile.name);
set(statusRef,{online:true,lastSeen:Date.now()});
onDisconnect(statusRef).set({online:false,lastSeen:Date.now()});
}

/* USERS LIST */
function loadUsers(){
onValue(ref(db,"users"),snap=>{
home.innerHTML="";
const users=snap.val()||{};
Object.values(users).forEach(u=>{
if(u.name===profile.name)return;

const div=document.createElement("div");
div.className="p-3 border-b border-[#2a3942] cursor-pointer hover:bg-[#202c33] fade";

const chatId=[profile.name,u.name].sort().join("_");

onValue(ref(db,"last/"+chatId),last=>{
const lastMsg=last.val()?.text||"";

onValue(ref(db,"status/"+u.name),s=>{
const st=s.val()||{};
const online=st.online?"üü¢":"‚ö´";
div.innerHTML=`
<div class="flex justify-between">
<div>${u.name} ${online}</div>
</div>
<div class="text-sm opacity-60 truncate">${lastMsg}</div>
`;
});
});

onValue(ref(db,"unread/"+profile.name+"/"+chatId),u=>{
const count=u.val()||0;
if(count>0){
const badge=document.createElement("span");
badge.className="float-right text-xs bg-[#005c4b] px-2 rounded-full";
badge.textContent=count;
div.appendChild(badge);
}
});

div.onclick=()=>openChat(u);
home.appendChild(div);
});
});
}

/* BACK */
backBtn.onclick=()=>{
chatScreen.classList.add("hidden");
home.classList.remove("hidden");
headerTitle.textContent="Chatly";
backBtn.classList.add("hidden");
currentUser=null;
currentChatId=null;
};

/* DAY LABEL */
function dayLabel(ts){
const d=new Date(ts);
const today=new Date();
const yest=new Date();yest.setDate(today.getDate()-1);
if(d.toDateString()===today.toDateString())return "Today";
if(d.toDateString()===yest.toDateString())return "Yesterday";
return d.toLocaleDateString();
}

/* OPEN CHAT */
function openChat(user){
currentUser=user;
currentChatId=[profile.name,user.name].sort().join("_");
home.classList.add("hidden");
chatScreen.classList.remove("hidden");
backBtn.classList.remove("hidden");
headerTitle.textContent=user.name;
chat.innerHTML="";
lastDay=null;

/* reset unread */
set(ref(db,"unread/"+profile.name+"/"+currentChatId),0);

onChildAdded(ref(db,"chats/"+currentChatId),snap=>{
const d=snap.val();

/* read receipts */
if(d.sender!==profile.name){
update(ref(db,"chats/"+currentChatId+"/"+snap.key),{read:true});
}

/* day separator */
const lbl=dayLabel(d.time);
if(lbl!==lastDay){
const sep=document.createElement("div");
sep.className="text-center text-xs opacity-60 my-2";
sep.textContent=lbl;
chat.appendChild(sep);
lastDay=lbl;
}

const div=document.createElement("div");
div.className="msg p-2 rounded-lg "+
(d.sender===profile.name?"bg-[#005c4b] ml-auto":"bg-[#202c33]");

const ticks=d.sender===profile.name?(d.read?"‚úî‚úî":"‚úî"):"";

div.innerHTML=`
${d.text}
<div class="text-xs opacity-60 text-right">
${new Date(d.time).toLocaleTimeString([],{
hour:"2-digit",minute:"2-digit"})}
${ticks}
</div>
`;

chat.appendChild(div);
chat.scrollTop=chat.scrollHeight;
});

/* typing */
onValue(ref(db,"typing/"+user.name),s=>{
typing.innerHTML=s.val()?`
${user.name}
<span class="typing-dot"></span>
<span class="typing-dot"></span>
<span class="typing-dot"></span>
`:"";
});
}

/* SEND */
window.send=()=>{
const text=msg.value.trim();
if(!text||!currentUser)return;

push(ref(db,"chats/"+currentChatId),{
sender:profile.name,
text,
time:Date.now(),
read:false
});

/* last message */
set(ref(db,"last/"+currentChatId),{
text,time:Date.now()
});

/* unread for receiver */
set(ref(db,"unread/"+currentUser.name+"/"+currentChatId),
(ref(db,"unread/"+currentUser.name+"/"+currentChatId)).key
);

onValue(ref(db,"unread/"+currentUser.name+"/"+currentChatId),s=>{
const c=s.val()||0;
set(ref(db,"unread/"+currentUser.name+"/"+currentChatId),c+1);
},{onlyOnce:true});

msg.value="";
};

/* typing */
msg.addEventListener("input",()=>{
if(!currentUser)return;
set(ref(db,"typing/"+profile.name),true);
setTimeout(()=>set(ref(db,"typing/"+profile.name),false),1200);
});
</script>

</body>
</html>
