<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

<div id="setup" class="fixed inset-0 bg-white flex flex-col items-center justify-center gap-3 z-50">
<h2 class="text-xl font-bold">Welcome to Chatly</h2>
<input id="username" placeholder="Username" class="border p-2 rounded">
<input type="file" id="photo">
<button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded">
Start
</button>
</div>

<div id="home" class="hidden flex flex-col h-full">
<div class="bg-blue-500 text-white p-3 font-bold">Chatly</div>
<div id="users" class="flex-1 overflow-y-auto p-2"></div>
</div>

<div id="chat" class="hidden flex flex-col h-full">
<div class="bg-blue-500 text-white p-3 flex items-center gap-2">
<button onclick="backHome()">â¬…</button>
<img id="chatPhoto" class="w-8 h-8 rounded-full">
<span id="chatName"></span>
</div>

<div id="messages" class="flex-1 overflow-y-auto p-3 flex flex-col gap-2"></div>

<div class="p-2 flex gap-2">
<input id="msgInput" class="flex-1 border p-2 rounded">
<button onclick="sendMessage()" class="bg-blue-500 text-white px-4 rounded">Send</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
getFirestore,doc,setDoc,getDoc,getDocs,
collection,addDoc,query,where,orderBy,onSnapshot,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
getStorage,ref,uploadBytes,getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
apiKey:"AIzaSyDaoRzu6_cpPxeAjoX6kbsTCUlf5Vpn4Kg",
authDomain:"chatly-2f097.firebaseapp.com",
databaseURL:"https://chatly-2f097-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chatly-2f097",
storageBucket:"chatly-2f097.firebasestorage.app",
messagingSenderId:"632092552334",
appId:"1:632092552334:web:b1390de09936da2516eddf"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const storage=getStorage(app);

const DEFAULT_PHOTO="https://i.imgur.com/6VBx3io.png";

let currentUser=null;
let currentChatUser=null;

const setup=document.getElementById("setup");
const home=document.getElementById("home");
const chat=document.getElementById("chat");
const usersDiv=document.getElementById("users");
const messagesDiv=document.getElementById("messages");

document.getElementById("startBtn").onclick=createUser;

async function createUser(){

let username=document.getElementById("username").value.trim();
let file=document.getElementById("photo").files[0];

if(!username) return alert("Enter username");

let refUser=doc(db,"users",username);
let snap=await getDoc(refUser);

if(snap.exists()) return alert("Username exists");

let photo=DEFAULT_PHOTO;

if(file){
let storageRef=ref(storage,"profiles/"+username);
await uploadBytes(storageRef,file);
photo=await getDownloadURL(storageRef);
}

await setDoc(refUser,{username,photo});

localStorage.setItem("chatlyUser",username);
startApp();
}

async function startApp(){

currentUser=localStorage.getItem("chatlyUser");
if(!currentUser) return;

setup.classList.add("hidden");
home.classList.remove("hidden");

loadUsers();
}

async function loadUsers(){

usersDiv.innerHTML="";
let snap=await getDocs(collection(db,"users"));

snap.forEach(docu=>{
let u=docu.data();
if(u.username===currentUser) return;

usersDiv.innerHTML+=`
<div onclick="openChat('${u.username}','${u.photo}')" 
class="bg-white p-2 rounded mb-2 flex items-center gap-2 cursor-pointer">
<img src="${u.photo}" class="w-10 h-10 rounded-full">
<span>${u.username}</span>
</div>
`;
});
}

window.openChat=function(name,photo){

currentChatUser=name;

home.classList.add("hidden");
chat.classList.remove("hidden");

document.getElementById("chatName").innerText=name;
document.getElementById("chatPhoto").src=photo;

loadMessages();
}

window.backHome=function(){
chat.classList.add("hidden");
home.classList.remove("hidden");
}

function chatId(){
return [currentUser,currentChatUser].sort().join("_");
}

function loadMessages(){

messagesDiv.innerHTML="";

const q=query(
collection(db,"messages"),
where("chatId","==",chatId()),
orderBy("time")
);

onSnapshot(q,snap=>{

messagesDiv.innerHTML="";

snap.forEach(docu=>{
let m=docu.data();

let side=m.sender===currentUser?"self-end bg-blue-500 text-white":"self-start bg-white";

let time=m.time?new Date(m.time.seconds*1000).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";

messagesDiv.innerHTML+=`
<div class="max-w-[70%] p-2 rounded ${side}">
<div>${m.text}</div>
<div class="text-xs opacity-70">${time}</div>
</div>
`;
});

messagesDiv.scrollTop=messagesDiv.scrollHeight;
});
}

window.sendMessage=async function(){

let input=document.getElementById("msgInput");
let text=input.value.trim();
if(!text) return;

await addDoc(collection(db,"messages"),{
chatId:chatId(),
sender:currentUser,
text:text,
time:serverTimestamp()
});

input.value="";
}

startApp();

</script>
</body>
</html>
