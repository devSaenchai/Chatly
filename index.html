<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chatly v2</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body{background:#0b141a}
.msg{max-width:75%}
</style>
</head>

<body class="h-screen flex flex-col text-white">

<div id="header" class="bg-[#202c33] p-3 font-semibold">
Chatly
</div>

<div id="home" class="flex-1 overflow-y-auto"></div>

<div id="chatScreen" class="hidden flex flex-col flex-1">
<div id="chat" class="flex-1 overflow-y-auto p-3 space-y-2"></div>

<div id="typing" class="text-xs px-3 opacity-70"></div>

<div class="bg-[#202c33] p-2 flex gap-2">
<input id="msg" class="flex-1 p-2 rounded-full text-black">
<button onclick="send()" class="bg-[#005c4b] px-4 rounded-full">
Send
</button>
</div>
</div>

<div id="setup"
class="fixed inset-0 bg-black/70 flex items-center justify-center">
<div class="bg-[#202c33] p-6 rounded-xl w-80 space-y-3">

<input id="nameInput"
placeholder="Username"
class="w-full p-2 rounded text-black">

<button onclick="saveProfile()"
class="bg-[#005c4b] w-full p-2 rounded">
Start
</button>

</div>
</div>

<script type="module">
import {initializeApp}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getDatabase,ref,set,push,
onValue,onChildAdded,
update,onDisconnect,serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyDaoRzu6_cpPxeAjoX6kbsTCUlf5Vpn4Kg",
authDomain:"chatly-2f097.firebaseapp.com",
databaseURL:"https://chatly-2f097-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chatly-2f097",
storageBucket:"chatly-2f097.firebasestorage.app",
messagingSenderId:"632092552334",
appId:"1:632092552334:web:b1390de09936da2516eddf"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let profile=JSON.parse(localStorage.getItem("chatlyUser"));
let currentUser=null;

if(profile){
setup.style.display="none";
setPresence();
loadChats();
}

function setPresence(){
const statusRef=ref(db,"status/"+profile.name);

set(statusRef,{online:true});
onDisconnect(statusRef).set({online:false});
}

/* PROFILE */
window.saveProfile=()=>{
let name=nameInput.value.trim();
if(!name)return;

profile={name};
localStorage.setItem("chatlyUser",JSON.stringify(profile));
set(ref(db,"users/"+name),profile);
location.reload();
};

/* LOAD CHAT LIST */
function loadChats(){
onValue(ref(db,"users"),snap=>{
home.innerHTML="";
let users=snap.val()||{};

Object.values(users).forEach(u=>{
if(u.name===profile.name)return;

let div=document.createElement("div");
div.className=
"p-3 border-b border-[#2a3942] cursor-pointer hover:bg-[#202c33]";

let chatId=[profile.name,u.name].sort().join("_");

onValue(ref(db,"last/"+chatId),last=>{
let lastMsg=last.val()?.text||"";

onValue(ref(db,"status/"+u.name),s=>{
let online=s.val()?.online?"ðŸŸ¢":"âš«";

div.innerHTML=`
<div class="flex justify-between">
<div>${u.name} ${online}</div>
</div>
<div class="text-sm opacity-60">${lastMsg}</div>
`;

});
});

div.onclick=()=>openChat(u);
home.appendChild(div);
});
});
}

/* OPEN CHAT */
function openChat(user){
currentUser=user;

home.classList.add("hidden");
chatScreen.classList.remove("hidden");

header.innerText=user.name;
chat.innerHTML="";

let chatId=[profile.name,user.name].sort().join("_");

onChildAdded(ref(db,"chats/"+chatId),snap=>{
let d=snap.val();

if(d.sender!==profile.name){
update(ref(db,"chats/"+chatId+"/"+snap.key),
{read:true});
}

let div=document.createElement("div");

div.className=
"msg p-2 rounded-lg "+
(d.sender===profile.name
?"bg-[#005c4b] ml-auto"
:"bg-[#202c33]");

let ticks=d.sender===profile.name
?(d.read?"âœ”âœ”":"âœ”")
:"";

div.innerHTML=`
${d.text}
<div class="text-xs opacity-60 text-right">
${new Date(d.time)
.toLocaleTimeString([],{
hour:"2-digit",minute:"2-digit"})}
${ticks}
</div>
`;

chat.appendChild(div);
chat.scrollTop=chat.scrollHeight;
});

/* typing */
onValue(ref(db,"typing/"+user.name),s=>{
typing.innerText=
s.val()?user.name+" typing...":"";
});
}

/* SEND */
window.send=()=>{
let text=msg.value.trim();
if(!text)return;

let chatId=[profile.name,currentUser.name]
.sort().join("_");

push(ref(db,"chats/"+chatId),{
sender:profile.name,
text,
time:Date.now(),
read:false
});

set(ref(db,"last/"+chatId),{
text,
time:Date.now()
});

msg.value="";
};

/* typing status */
msg.addEventListener("input",()=>{
if(!currentUser)return;
set(ref(db,"typing/"+profile.name),true);
setTimeout(()=>{
set(ref(db,"typing/"+profile.name),false);
},1000);
});
</script>
</body>
</html>
