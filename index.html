<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chatly</title>

<style>
body{
margin:0;
font-family:system-ui;
background:#efeae2;
display:flex;
flex-direction:column;
height:100vh;
}

/* HEADER */
.topbar{
background:#075e54;
color:white;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
font-weight:bold;
}

/* CHAT AREA */
#chat{
flex:1;
overflow-y:auto;
padding:10px;
display:flex;
flex-direction:column;
}

/* MESSAGE BUBBLES */
.msg{
max-width:75%;
padding:8px 10px;
margin:4px 0;
border-radius:8px;
font-size:14px;
word-wrap:break-word;
display:flex;
gap:6px;
align-items:flex-start;
}

.me{
background:#d9fdd3;
align-self:flex-end;
flex-direction:row-reverse;
}

.other{
background:white;
align-self:flex-start;
}

.avatar{
width:28px;
height:28px;
border-radius:50%;
}

/* INPUT BAR */
.inputbar{
display:flex;
padding:8px;
background:#f0f2f5;
gap:6px;
}

.inputbar input{
flex:1;
padding:10px;
border-radius:20px;
border:none;
outline:none;
}

.inputbar button{
background:#075e54;
color:white;
border:none;
padding:10px 14px;
border-radius:50%;
}

/* POPUPS */
.popup{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:#0008;
display:flex;
justify-content:center;
align-items:center;
}

.box{
background:white;
padding:20px;
border-radius:10px;
width:85%;
max-width:320px;
text-align:center;
}

/* MOBILE OPTIMIZATION */
@media(min-width:700px){
body{
max-width:500px;
margin:auto;
border-left:1px solid #ccc;
border-right:1px solid #ccc;
}
}
</style>
</head>

<body>

<div class="topbar">
<span>Chatly</span>
<span id="profileBtn">ðŸ‘¤</span>
</div>

<div id="chat"></div>

<div class="inputbar">
<input id="msg" placeholder="Message">
<button onclick="send()">âž¤</button>
</div>

<!-- USER POPUP -->
<div id="userPopup" class="popup">
<div class="box">
<h3>Enter Username</h3>
<input id="usernameInput"><br><br>
<button onclick="setUser()">Continue</button>
<div id="continueOld"></div>
</div>
</div>

<!-- PROFILE POPUP -->
<div id="profilePopup" class="popup" style="display:none">
<div class="box">
<h3>Edit Profile</h3>
<input id="editName" placeholder="New name"><br><br>
<input type="file" id="editPic"><br><br>
<button onclick="saveProfile()">Save</button>
<button onclick="closeProfile()">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onChildAdded }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyDaoRzu6_cpPxeAjoX6kbsTCUlf5Vpn4Kg",
authDomain:"chatly-2f097.firebaseapp.com",
databaseURL:"https://chatly-2f097-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chatly-2f097",
storageBucket:"chatly-2f097.firebasestorage.app",
messagingSenderId:"632092552334",
appId:"1:632092552334:web:b1390de09936da2516eddf"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let username="";
let avatar="https://i.imgur.com/6VBx3io.png";

/* CONTINUE OLD USER */
if(localStorage.user){
let u=JSON.parse(localStorage.user);
document.getElementById("continueOld").innerHTML=
`<br><button onclick="continueOld()">Continue as ${u.name}</button>`;
}

window.continueOld=()=>{
let u=JSON.parse(localStorage.user);
username=u.name;
avatar=u.avatar;
userPopup.style.display="none";
};

window.setUser=()=>{
username=usernameInput.value;
localStorage.user=JSON.stringify({name:username,avatar});
userPopup.style.display="none";
};

/* SEND MESSAGE */
window.send=()=>{
let text=msg.value.trim();
if(!text)return;
push(ref(db,"msgs"),{name:username,text,avatar});
msg.value="";
};

/* LOAD MESSAGES */
onChildAdded(ref(db,"msgs"),snap=>{
let d=snap.val();

let div=document.createElement("div");
div.className="msg "+(d.name===username?"me":"other");

div.innerHTML=`
<img class="avatar" src="${d.avatar}">
<div><b>${d.name}</b><br>${d.text}</div>
`;

chat.appendChild(div);
chat.scrollTop=chat.scrollHeight;
});

/* PROFILE */
profileBtn.onclick=()=>{
profilePopup.style.display="flex";
};

window.closeProfile=()=>{
profilePopup.style.display="none";
};

window.saveProfile=()=>{
let newName=editName.value||username;
let file=editPic.files[0];

if(file){
let reader=new FileReader();
reader.onload=e=>{
avatar=e.target.result;
username=newName;
localStorage.user=JSON.stringify({name:username,avatar});
closeProfile();
};
reader.readAsDataURL(file);
}else{
username=newName;
localStorage.user=JSON.stringify({name:username,avatar});
closeProfile();
}
};
</script>

</body>
</html>
