<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chatly</title>

<style>
body{font-family:Arial;margin:0;background:#ece5dd}
#chat{height:85vh;overflow-y:auto;padding:10px}
.msg{max-width:60%;padding:8px;margin:6px;border-radius:10px}
.me{background:#dcf8c6;margin-left:auto;text-align:right}
.other{background:white;margin-right:auto}
.topbar{background:#075e54;color:white;padding:10px;display:flex;justify-content:space-between}
#profileBtn{cursor:pointer}
img.avatar{width:30px;height:30px;border-radius:50%;vertical-align:middle;margin-right:5px}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:#0008;display:flex;justify-content:center;align-items:center}
.box{background:white;padding:20px;border-radius:10px;text-align:center}
</style>
</head>

<body>

<div class="topbar">
<span>Chatly</span>
<span id="profileBtn">⚙️ Profile</span>
</div>

<div id="chat"></div>

<div style="display:flex">
<input id="msg" style="flex:1;padding:10px">
<button onclick="send()">Send</button>
</div>

<!-- Username Popup -->
<div id="userPopup" class="popup">
<div class="box">
<h3>Select Username</h3>
<input id="usernameInput"><br><br>
<button onclick="setUser()">Continue</button>
<div id="continueOld"></div>
</div>
</div>

<!-- Profile Popup -->
<div id="profilePopup" class="popup" style="display:none">
<div class="box">
<h3>Edit Profile</h3>
<input id="editName"><br><br>
<input type="file" id="editPic"><br><br>
<button onclick="saveProfile()">Save</button>
<button onclick="closeProfile()">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
apiKey:"AIzaSyDaoRzu6_cpPxeAjoX6kbsTCUlf5Vpn4Kg",
authDomain:"chatly-2f097.firebaseapp.com",
databaseURL:"https://chatly-2f097-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chatly-2f097",
storageBucket:"chatly-2f097.firebasestorage.app",
messagingSenderId:"632092552334",
appId:"1:632092552334:web:b1390de09936da2516eddf"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let username="";
let avatar="https://i.imgur.com/6VBx3io.png"; // default avatar

// check old user
if(localStorage.user){
document.getElementById("continueOld").innerHTML=
`<button onclick="continueOld()">Continue as ${JSON.parse(localStorage.user).name}</button>`;
}

window.continueOld=()=>{
let u=JSON.parse(localStorage.user);
username=u.name;
avatar=u.avatar;
document.getElementById("userPopup").style.display="none";
};

window.setUser=()=>{
username=document.getElementById("usernameInput").value;
localStorage.user=JSON.stringify({name:username,avatar});
document.getElementById("userPopup").style.display="none";
};

window.send=()=>{
let text=document.getElementById("msg").value;
push(ref(db,"msgs"),{name:username,text,avatar});
document.getElementById("msg").value="";
};

onChildAdded(ref(db,"msgs"),snap=>{
let d=snap.val();
let div=document.createElement("div");
div.className="msg "+(d.name===username?"me":"other");
div.innerHTML=`<img class="avatar" src="${d.avatar}">
<b>${d.name}</b><br>${d.text}`;
document.getElementById("chat").appendChild(div);
});

// profile popup
document.getElementById("profileBtn").onclick=()=>{
document.getElementById("profilePopup").style.display="flex";
};

window.closeProfile=()=>{
document.getElementById("profilePopup").style.display="none";
};

window.saveProfile=()=>{
let newName=document.getElementById("editName").value||username;
let file=document.getElementById("editPic").files[0];

if(file){
let reader=new FileReader();
reader.onload=e=>{
avatar=e.target.result;
username=newName;
localStorage.user=JSON.stringify({name:username,avatar});
closeProfile();
};
reader.readAsDataURL(file);
}else{
username=newName;
localStorage.user=JSON.stringify({name:username,avatar});
closeProfile();
}
};
</script>

</body>
</html>
