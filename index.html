<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chatly</title>

<style>
body{
margin:0;
font-family:system-ui;
background:#efeae2;
display:flex;
flex-direction:column;
height:100vh;
}

/* HEADER */
.header{
background:#075e54;
color:white;
padding:10px;
display:flex;
align-items:center;
justify-content:space-between;
}

.profileMini{
display:flex;
align-items:center;
gap:8px;
cursor:pointer;
}

.profileMini img{
width:32px;
height:32px;
border-radius:50%;
}

/* CHAT */
#chat{
flex:1;
overflow-y:auto;
padding:10px;
display:flex;
flex-direction:column;
gap:4px;
scroll-behavior:smooth;
}

.msg{
max-width:80%;
display:flex;
gap:6px;
animation:fade .2s ease;
}

@keyframes fade{
from{opacity:0;transform:translateY(6px);}
to{opacity:1;}
}

.me{align-self:flex-end;flex-direction:row-reverse;}
.other{align-self:flex-start;}

.avatar{
width:28px;height:28px;border-radius:50%;
}

.bubble{
background:white;
padding:8px 10px;
border-radius:10px;
font-size:14px;
}

.me .bubble{background:#d9fdd3;}

.meta{
font-size:11px;
opacity:.6;
text-align:right;
margin-top:2px;
}

/* INPUT */
.inputbar{
display:flex;
padding:8px;
background:#f0f2f5;
gap:6px;
}

.inputbar input{
flex:1;
padding:10px;
border-radius:20px;
border:none;
outline:none;
}

.inputbar button{
background:#075e54;
color:white;
border:none;
border-radius:50%;
padding:10px 14px;
}

/* POPUPS */
.popup{
position:fixed;
top:0;left:0;width:100%;height:100%;
background:#0008;
display:flex;
justify-content:center;
align-items:center;
}

.box{
background:white;
padding:20px;
border-radius:12px;
width:90%;
max-width:340px;
text-align:center;
}

.box img{
width:70px;
height:70px;
border-radius:50%;
margin-bottom:10px;
}

.box input{
width:100%;
padding:8px;
margin-top:6px;
}

.box button{
margin-top:10px;
padding:8px 12px;
background:#075e54;
color:white;
border:none;
border-radius:6px;
}
</style>
</head>

<body>

<div class="header">
<div>Chatly</div>
<div class="profileMini" onclick="openProfile()">
<img id="miniAvatar">
<span id="miniName"></span>
</div>
</div>

<div id="chat"></div>

<div class="inputbar">
<input id="msg" placeholder="Message">
<button onclick="send()">âž¤</button>
</div>

<!-- PROFILE SETUP -->
<div id="setupPopup" class="popup">
<div class="box">
<h3>Welcome to Chatly</h3>
<img id="previewAvatar" src="https://i.pravatar.cc/150">
<input id="usernameInput" placeholder="Enter username">
<input type="file" id="avatarInput">
<button onclick="saveProfile()">Start Chat</button>
</div>
</div>

<!-- PROFILE EDIT -->
<div id="editPopup" class="popup" style="display:none">
<div class="box">
<h3>Edit Profile</h3>
<img id="editPreview">
<input id="editName">
<input type="file" id="editAvatar">
<button onclick="updateProfile()">Save</button>
<button onclick="closeProfile()">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onChildAdded,
update, query, orderByChild }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyDaoRzu6_cpPxeAjoX6kbsTCUlf5Vpn4Kg",
authDomain:"chatly-2f097.firebaseapp.com",
databaseURL:"https://chatly-2f097-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chatly-2f097",
storageBucket:"chatly-2f097.firebasestorage.app",
messagingSenderId:"632092552334",
appId:"1:632092552334:web:b1390de09936da2516eddf"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let profile=JSON.parse(localStorage.getItem("chatlyProfile"));

if(profile){
setupPopup.style.display="none";
applyProfile();
}

function applyProfile(){
miniName.innerText=profile.name;
miniAvatar.src=profile.avatar;
}

/* SAVE PROFILE */
window.saveProfile=()=>{
let name=usernameInput.value.trim();
if(!name)return;

let file=avatarInput.files[0];

if(file){
let r=new FileReader();
r.onload=e=>{
profile={name,avatar:e.target.result};
localStorage.setItem("chatlyProfile",JSON.stringify(profile));
location.reload();
};
r.readAsDataURL(file);
}else{
profile={name,avatar:"https://i.pravatar.cc/150?u="+name};
localStorage.setItem("chatlyProfile",JSON.stringify(profile));
location.reload();
}
};

/* EDIT PROFILE */
window.openProfile=()=>{
editPopup.style.display="flex";
editName.value=profile.name;
editPreview.src=profile.avatar;
};

window.closeProfile=()=>{
editPopup.style.display="none";
};

window.updateProfile=()=>{
let newName=editName.value||profile.name;
let file=editAvatar.files[0];

if(file){
let r=new FileReader();
r.onload=e=>{
profile={name:newName,avatar:e.target.result};
localStorage.setItem("chatlyProfile",JSON.stringify(profile));
location.reload();
};
r.readAsDataURL(file);
}else{
profile.name=newName;
localStorage.setItem("chatlyProfile",JSON.stringify(profile));
location.reload();
}
};

/* TIME FORMAT */
function formatTime(t){
let d=new Date(t);
let h=d.getHours();
let m=d.getMinutes();
if(m<10)m="0"+m;
return h+":"+m;
}

/* SEND */
window.send=()=>{
let text=msg.value.trim();
if(!text)return;

push(ref(db,"msgs"),{
name:profile.name,
avatar:profile.avatar,
text,
time:Date.now()
});

msg.value="";
};

/* LOAD MESSAGES */
const msgQuery=query(ref(db,"msgs"),orderByChild("time"));

onChildAdded(msgQuery,snap=>{
let d=snap.val();

let div=document.createElement("div");
div.className="msg "+(d.name===profile.name?"me":"other");

div.innerHTML=`
<img class="avatar" src="${d.avatar}">
<div class="bubble">
<b>${d.name}</b><br>
${d.text}
<div class="meta">${formatTime(d.time)}</div>
</div>
`;

chat.appendChild(div);
chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>
